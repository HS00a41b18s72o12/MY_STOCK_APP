{% extends "base.html" %}
{% block title %}ポートフォリオ一覧{% endblock %}
{% block content %}
<!-- ソート可能なヘッダーリンクを生成するマクロ -->
{% macro sort_link(label, column) %}
{% set next_order = 'desc' if current_sort == column and current_order == 'asc' else 'asc' %}
<!-- href に group_filter=current_group を追加 -->
<a href="{{ url_for('index', sort=column, order=next_order, group_filter=current_group) }}"
    class="group inline-flex items-center space-x-1 cursor-pointer hover:text-gray-800 hover:bg-gray-100 px-2 py-1 rounded">
    <span>{{ label }}</span>
    <span class="text-gray-400 text-[10px] flex flex-col leading-[0.5] group-hover:text-gray-600">
        <span class="{{ 'text-blue-600' if current_sort == column and current_order == 'asc' else '' }}">▲</span>
        <span class="{{ 'text-blue-600' if current_sort == column and current_order == 'desc' else '' }}">▼</span>
    </span>
</a>
{% endmacro %}

<!-- 銘柄登録フォーム -->
<details class="sticky top-0 z-40 bg-gray-50 opacity-90 rounded-lg shadow-md mb-8 group border border-gray-200">
    <summary
        class="list-none p-6 cursor-pointer flex items-center justify-between outline-none select-none bg-white rounded-lg group-open:rounded-b-none">

        <!-- タイトル -->
        <h2 class="text-xl font-bold text-gray-700">銘柄の登録・更新</h2>

        <!-- 開閉アイコン -->
        <!-- group-open:rotate-180 で、開いた時に180度回転させます -->
        <div class="text-gray-400 transition-transform duration-300 group-open:rotate-180">
            <!-- 下矢印のSVGアイコン -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </summary>
    <!-- ここから下が折りたたまれる内容 -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <form method="POST" action="/" class="flex flex-wrap items-end gap-4">
            <!-- 現在の表示状態を維持するための隠しフィールド -->
            <!-- これにより、保存ボタンを押した時にこれらの値も一緒にBackendに送られます -->
            <input type="hidden" name="keep_sort" value="{{ current_sort }}">
            <input type="hidden" name="keep_order" value="{{ current_order }}">
            <!-- group は None の場合に空文字になるように調整 -->
            <input type="hidden" name="keep_group" value="{{ current_group if current_group else '' }}">

            <div class="w-24">
                <label class="block text-sm font-medium text-gray-700">銘柄コード</label>
                <input type="text" name="stock_code" id="input_stock_code" required
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: 7203">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">銘柄名</label>
                <input type="text" name="stock_name" id="input_stock_name"
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: トヨタ">
            </div>
            <div class="w-24">
                <label class="block text-sm font-medium text-gray-700">保有株数</label>
                <input type="number" id=stock_number name="number" step=1
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: 100">
            </div>
            <div class="w-32">
                <label class="block text-sm font-medium text-gray-700">取得単価</label>
                <input type="number" id=stock_average_price name="average_price" step="0.01"
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: 2000">
            </div>
            <div class="w-32">
                <label class="block text-sm font-medium text-gray-700">目標売り価格</label>
                <input type="number" id=stock_target_sell_price name="target_sell_price" step="0.01"
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: 2000">
            </div>
            <div class="w-32">
                <label class="block text-sm font-medium text-gray-700">目標買い価格</label>
                <input type="number" id=stock_target_buy_price name="target_buy_price" step="0.01"
                    class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="例: 2000">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">メモ</label>
                <input type="text" name="remarks" step="0.01" class="mt-1 block border border-gray-300 rounded-md p-2"
                    placeholder="例: 権利確定日は3月">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">分類</label>
                <select name="group" class="mt-1 block border border-gray-300 rounded-md p-2 w-full">
                    <option value="" selected>未選択</option>
                    <option value="長期保有">長期保有</option>
                    <option value="短期保有">短期保有</option>
                    <option value="優待株">優待株</option>
                </select>
            </div>
            <div class="w-24">
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition duration-150">
                    保存
                </button>
            </div>
        </form>
    </div>
</details>


<!-- ポートフォリオサマリー -->
<h2 class="text-xl font-bold mb-4">ポートフォリオ・サマリー <span class="text-sm font-normal text-gray-500">({{ current_group if
        current_group else 'すべて' }})</span></h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <!-- 1. 時価総額 -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500 mb-1">時価総額合計</p>
        <p class="text-2xl font-bold text-gray-900">{{ "{:,}".format(summary.market_value) }} <span
                class="text-sm font-normal">円</span></p>
    </div>
    <!-- 2. 前日比合計 -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500 mb-1">前日比合計</p>
        <div class="flex items-baseline gap-2">
            {% if summary.day_change_yen >= 0 %}
            <p class="text-2xl font-bold text-green-600">+{{ "{:,}".format(summary.day_change_yen) }} 円</p>
            <p class="text-sm font-semibold text-green-600">(+{{ summary.day_change_percent }}%)</p>
            {% else %}
            <p class="text-2xl font-bold text-red-600">{{ "{:,}".format(summary.day_change_yen) }} 円</p>
            <p class="text-sm font-semibold text-red-600">({{ summary.day_change_percent }}%)</p>
            {% endif %}
        </div>
    </div>
    <!-- 3. 評価損益合計 -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <p class="text-sm text-gray-500 mb-1">評価損益合計</p>
        <div class="flex items-baseline gap-2">
            {% if summary.profit_yen >= 0 %}
            <p class="text-2xl font-bold text-green-600">+{{ "{:,}".format(summary.profit_yen) }} 円</p>
            <p class="text-sm font-semibold text-green-600">(+{{ summary.profit_percent }}%)</p>
            {% else %}
            <p class="text-2xl font-bold text-red-600">{{ "{:,}".format(summary.profit_yen) }} 円</p>
            <p class="text-sm font-semibold text-red-600">({{ summary.profit_percent }}%)</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- グラフ・分析エリア -->
<details class="bg-white rounded-lg shadow-md mb-8 group border border-gray-200" close>
    <summary
        class="list-none p-6 cursor-pointer flex items-center justify-between outline-none select-none bg-white rounded-lg group-open:rounded-b-none">
        <h2 class="text-xl font-bold text-gray-700">ポートフォリオ分析</h2>
        <div class="text-gray-400 transition-transform duration-300 group-open:rotate-180">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </summary>

    <div class="p-6 border-t border-gray-100 bg-gray-50">
        <!-- 上段: 推移グラフ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- ①資産推移 (全体) -->
            <div class="bg-white p-4 rounded shadow-sm h-80">
                <h3 class="text-center font-bold mb-2 text-gray-600 text-sm">資産推移 (全体)</h3>
                <div class="relative h-full w-full pb-6">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
            <!-- ②資産推移 (グループ別積み上げ) -->
            <div class="bg-white p-4 rounded shadow-sm h-80">
                <h3 class="text-center font-bold mb-2 text-gray-600 text-sm">資産推移 (分類別)</h3>
                <div class="relative h-full w-full pb-6">
                    <canvas id="groupHistoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 下段: 構成比率 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- ③セクター比率 -->
            <div class="bg-white p-4 rounded shadow-sm h-96">
                <h3 class="text-center font-bold mb-2 text-gray-600 text-sm">セクター比率</h3>
                <div class="relative h-full w-full pb-6">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>

            <!-- ④ヒートマップ (TreeMap) -->
            <div class="bg-white p-4 rounded shadow-sm h-96 lg:col-span-2">
                <h3 class="text-center font-bold mb-2 text-gray-600 text-sm">保有銘柄ヒートマップ (時価総額)</h3>
                <div class="relative h-full w-full pb-6">
                    <canvas id="treeMapChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</details>

<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
    <h1 class="text-xl font-bold">保有銘柄一覧</h1>

    <!-- フィルタリングボタン群 -->
    <div class="inline-flex rounded-md shadow-sm" role="group">
        <!-- 1. 保有株すべて (ボタン名を変更) -->
        <a href="{{ url_for('index', sort=current_sort, order=current_order, group_filter='holdings') }}"
            class="px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-lg 
                  {{ 'bg-blue-600 text-white' if current_group == 'holdings' or current_group == None else 'bg-white text-gray-700 hover:bg-gray-100' }}">
            保有株全件
        </a>
        <!-- 監視リスト -->
        <a href="{{ url_for('index', sort=current_sort, order=current_order, group_filter='watchlist') }}"
            class="px-4 py-2 text-sm font-medium border-t border-b border-r border-gray-200 
                  {{ 'bg-blue-600 text-white' if current_group == 'watchlist' else 'bg-white text-gray-700 hover:bg-gray-100' }}">
            監視リスト
        </a>
        <!-- 各グループボタン -->
        {% for g in ['長期保有', '短期保有', '優待株'] %}
        <a href="{{ url_for('index', sort=current_sort, order=current_order, group_filter=g) }}"
            class="px-4 py-2 text-sm font-medium border-t border-b border-r border-gray-200 
                  {{ 'bg-blue-600 text-white' if current_group == g else 'bg-white text-gray-700 hover:bg-gray-100' }}">
            {{ g }}
        </a>
        {% endfor %}

        <!-- 「未分類」ボタン -->
        <a href="{{ url_for('index', sort=current_sort, order=current_order, group_filter='未分類') }}"
            class="px-4 py-2 text-sm font-medium border-t border-b border-r border-gray-200 rounded-r-lg
                  {{ 'bg-blue-600 text-white' if current_group == '未分類' else 'bg-white text-gray-700 hover:bg-gray-100' }}">
            未分類
        </a>
    </div>
</div>

<div class="bg-white border rounded-lg shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        {{ sort_link('銘柄', 'stock_code') }}
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        {{ sort_link('現在値 / 前日比', 'price_diff_percent') }}
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        {{ sort_link('損益', 'profit_percent') }}
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        {{ sort_link('保有 / 取得単価', 'number') }}
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        指標 (PER/PBR/配当)
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider min-w-[300px]">
                        AI分析 (直近開示)
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        メモ
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        分類
                    </th>
                    <th scope="col"
                        class="px-4 py-3 text-left text-xm font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        操作
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for c in stock_contents %}
                <tr class="hover:bg-blue-50 transition duration-150 cursor-pointer row-clickable"
                    data-code="{{ c.stock_code }}" data-name="{{ c.stock_name }}" data-number="{{ c.number }}"
                    data-price="{{ c.average_price }}"
                    data-sell="{{ c.target_sell_price if c.target_sell_price else '' }}"
                    data-buy="{{ c.target_buy_price if c.target_buy_price else '' }}"
                    data-remarks="{{ c.remarks if c.remarks != '-' else '' }}"
                    data-group="{{ c.group if c.group != '-' else '' }}">
                    <!-- 1. 銘柄情報 -->
                    <td class="px-4 py-4 whitespace-nowrap align-top">
                        <!-- <div class="text-lg font-bold text-gray-900">{{ c.stock_name }}</div>
                        <div class="text-xs text-gray-500 font-mono">{{ c.stock_code }}</div> -->
                        <span class="text-xs text-gray-500 font-mono">{{ c.stock_code }}</span>
                        <span class="text-base font-bold text-gray-900">{{ c.stock_name }}</span>
                        <div class="flex flex-wrap gap-1 mt-2">
                            <!-- バッジ類 -->
                            {% if c.is_profitable %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                黒字
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                                赤字
                            </span>
                            {% endif %}

                            {% if c.mix_coefficient is not none %}
                            {% if c.mix_coefficient <= 11.25 %} <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 border border-indigo-200"
                                title="ミックス係数: {{ c.mix_coefficient|round(1) }}">
                                超割安
                                </span>
                                {% elif c.mix_coefficient <= 22.5 %} <span
                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200"
                                    title="ミックス係数: {{ c.mix_coefficient|round(1) }}">
                                    割安
                                    </span>
                                    {% endif %}
                                    {% endif %}

                                    {% if c.payout_ratio is not none %}
                                    {% if c.payout_ratio > 80 %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800 border border-orange-200"
                                        title="配当性向: {{ c.payout_ratio|round(1) }}%">
                                        配当高負荷
                                    </span>
                                    {% elif c.payout_ratio < 30 %} <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-teal-100 text-teal-800 border border-teal-200"
                                        title="配当性向: {{ c.payout_ratio|round(1) }}%">
                                        増配余地
                                        </span>
                                        {% endif %}
                                        {% endif %}
                        </div>
                    </td>
                    <!-- 2. 現在値・前日比 (大きく) -->
                    <td class="px-4 py-4 whitespace-nowrap text-right align-top">
                        <div class="text-base font-bold text-gray-900">{{ "{:,}".format(c.current_price) }} 円</div>
                        <!-- プラスなら緑、マイナスなら赤 -->
                        {% if c.price_diff|float >= 0 %}
                        <div class="text-xs font-semibold text-green-600 mt-1">
                            +{{ c.price_diff }} (+{{ c.price_diff_percent }}%)
                        </div>
                        {% else %}
                        <div class="text-xs font-semibold text-red-600 mt-1">
                            {{ c.price_diff }} ({{ c.price_diff_percent }}%)
                        </div>
                        {% endif %}
                    </td>
                    <!-- 3. 損益 -->
                    <td class="px-4 py-4 whitespace-nowrap text-right align-top">
                        {% if c.profit_yen|float >= 0 %}
                        <div class="text-base font-bold text-green-600">+{{ "{:,}".format(c.profit_yen) }} 円</div>
                        <div class="text-xs font-semibold text-green-600 mt-1">+{{ c.profit_percent }}%</div>
                        {% else %}
                        <div class="text-base font-bold text-red-600">{{ "{:,}".format(c.profit_yen) }} 円</div>
                        <div class="text-xs font-semibold text-red-600 mt-1">{{ c.profit_percent }}%</div>
                        {% endif %}
                    </td>
                    <!-- 4. 保有状況 -->
                    <td class="px-4 py-4 whitespace-nowrap text-right align-top">
                        <div class="text-base text-gray-900">{{ c.number }} 株</div>
                        <div class="text-xs text-gray-500 mt-1">@{{ c.average_price }} 円</div>
                    </td>
                    <!-- 5. 指標 -->
                    <td class="px-4 py-4 whitespace-nowrap text-left align-top">
                        <div class="text-base text-gray-700">
                            PER: <span class="font-bold text-gray-900">{{ c.per }}</span> <span
                                class="text-gray-400 mx-1">/</span>
                            PBR: <span class="font-bold text-gray-900">{{ c.pbr }}</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            配当: <span class="font-medium">{{ c.dividend_yield_percent }}%</span> ({{ c.dividend_amount
                            }}円)
                        </div>
                    </td>
                    <!-- 6. AI分析結果 -->
                    <td class="px-4 py-4 text-sm align-top min-w-[300px]">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm text-gray-500 font-mono">{{ c.announce_date }}</span>
                            <!-- 増収増益バッジ -->
                            {% if c.sales_growth and c.sales_growth != '-' %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                売上 {{ c.sales_growth }}
                            </span>
                            {% endif %}
                            {% if c.profit_growth and c.profit_growth != '-' %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                利益 {{ c.profit_growth }}
                            </span>
                            {% endif %}
                        </div>
                        <!-- PDFリンク付きタイトル -->
                        {% if c.pdf_url %}
                        <a href="{{ c.pdf_url }}" target="_blank"
                            class="text-blue-600 hover:text-blue-800 hover:underline font-medium block truncate max-w-sm text-xs"
                            title="{{ c.title }}">
                            {{ c.title }} <i class="ml-1 text-xs">PDF</i>
                        </a>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                        <!-- AI要約 (アコーディオン) -->
                        {% if c.summary and c.summary != '-' %}
                        <details class="mt-2 text-xs group">
                            <summary
                                class="cursor-pointer text-gray-500 hover:text-gray-700 font-medium select-none list-none flex items-center gap-1">
                                <span class="group-open:hidden">▶ 要約を見る</span>
                                <span class="hidden group-open:inline">▼ 閉じる</span>
                            </summary>
                            <div
                                class="mt-1 p-3 bg-gray-50 rounded border border-gray-100 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">
                                {{ c.summary }}
                            </div>
                        </details>
                        {% endif %}
                    </td>
                    <!-- 7. メモ -->
                    <td class="px-4 py-4 whitespace-nowrap text-left align-top max-w-xs truncate">
                        <div class="text-sm text-gray-700 truncate" title="{{ c.remarks }}">{{ c.remarks }}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            {% if c.target_sell_price == 0.0 and c.target_buy_price == 0.0 %}
                            {% elif c.target_sell_price == None and c.target_buy_price == None %}
                            {% else %}
                            目標売値: {{ c.target_sell_price if c.target_sell_price else '-' }} 円 /
                            目標買値: {{ c.target_buy_price if c.target_buy_price else '-' }} 円
                            {% endif %}
                        </div>
                    </td>
                    <!-- 8. 分類 -->
                    <td class="px-4 py-4 whitespace-nowrap text-left align-top  min-w-[200px]">
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            {{ c.group }}
                        </span>
                    </td>
                    <!-- 9. 操作 -->
                    <td class="px-4 py-4 whitespace-nowrap text-right align-top">
                        <form action="/delete" method="POST" class="delete-form"
                            onsubmit="return confirm('本当に「{{ c.stock_name }}」を削除しますか？\n関連するデータもすべて削除されます。');">
                            <input type="hidden" name="stock_code" value="{{ c.stock_code }}">
                            <button type="submit"
                                class="text-red-500 hover:text-red-700 font-bold text-sm bg-transparent border-none cursor-pointer p-2 z-10 relative">
                                削除
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500">
                        登録されている銘柄はありません。上のフォームから登録してください。
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const codeInput = document.getElementById("input_stock_code");
        const nameInput = document.getElementById("input_stock_name");

        // 銘柄コード入力欄からフォーカスが外れた時(blur)に実行
        codeInput.addEventListener("blur", async () => {
            const code = codeInput.value.trim();

            // コードが4桁(以上)で、かつ銘柄名が空欄の時だけ実行
            if (code.length >= 4 && nameInput.value === "") {
                try {
                    // ユーザーに処理中であることを伝える
                    nameInput.placeholder = "取得中...";
                    nameInput.value = ""; // 入力をクリア

                    // APIを呼び出す
                    const response = await fetch(`/api/get_stock_name/${code}`);
                    const data = await response.json();

                    if (data.status === "success") {
                        nameInput.value = data.name;
                    } else {
                        nameInput.placeholder = "見つかりませんでした";
                    }
                } catch (error) {
                    console.error("Error fetching stock name:", error);
                    nameInput.placeholder = "エラー発生";
                }
            }

        });



        // === 追加機能: 行クリックでフォームに値をセット ===
        const formDetails = document.querySelector('details');
        const rows = document.querySelectorAll('.row-clickable');

        // フォームの各Input要素を取得
        const inputCode = document.getElementById("input_stock_code");
        const inputName = document.getElementById("input_stock_name");
        const inputNumber = document.querySelector('input[name="number"]');
        const inputPrice = document.querySelector('input[name="average_price"]');
        const inputSell = document.querySelector('input[name="target_sell_price"]');
        const inputBuy = document.querySelector('input[name="target_buy_price"]');
        const inputRemarks = document.querySelector('input[name="remarks"]');
        const selectGroup = document.querySelector('select[name="group"]');

        rows.forEach(row => {
            row.addEventListener('click', (e) => {
                // 削除ボタンやリンク、アコーディオンをクリックした場合は無視する
                if (e.target.closest('form.delete-form') || e.target.closest('a') || e.target.closest('details')) {
                    return;
                }

                // data属性から値を取得
                const d = row.dataset;

                // フォームに値をセット
                inputCode.value = d.code;
                inputName.value = d.name;
                inputNumber.value = d.number;
                inputPrice.value = d.price;
                inputSell.value = d.sell; // 値がなければ空文字が入る
                inputBuy.value = d.buy;
                inputRemarks.value = d.remarks;
                selectGroup.value = d.group || ""; // 分類を選択（なければ未選択）

                // フォームが閉じていたら開く
                if (!formDetails.open) {
                    formDetails.open = true;
                }

                // 視覚的なフィードバック（フォームまでスクロール & コード欄にフォーカス）
                // stickyヘッダーなのでスクロールは不要かもしれませんが、念のため
                // inputCode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // inputCode.focus();
            });
        });
    });
</script>

<script>
    const input_stock_number = document.getElementById('stock_number');
    const input_stock_average_price = document.getElementById('stock_average_price');
    const input_target_sell_price = document.getElementById('stock_target_sell_price');
    const input_target_buy_price = document.getElementById('stock_target_buy_price');

    input_stock_number.addEventListener('keydown', function (event) {
        let currentVal = parseInt(input_stock_number.value) || 0;
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            input_stock_number.value = currentVal + 100;
        } else if (event.key === 'ArrowDown') {
            event.preventDefault(); // デフォルトの動作を防止
            input_stock_number.value = Math.max(0, currentVal - 100);
        }
    });
    input_stock_average_price.addEventListener('keydown', function (event) {
        let currentVal = parseFloat(input_stock_average_price.value) || 0.0;
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            input_stock_average_price.value = currentVal + 1000;  // 1000増加
        } else if (event.key === 'ArrowDown') {
            event.preventDefault(); // デフォルトの動作を防止
            input_stock_average_price.value = Math.max(0, currentVal - 1000);  // 1000減少
        }
    });
    input_target_sell_price.addEventListener('keydown', function (event) {
        let currentVal = parseFloat(input_target_sell_price.value) || 0.0;
        if (event.key === 'ArrowUp') {
            event.preventDefault(); // デフォルトの動作を防止
            input_target_sell_price.value = currentVal + 1000;  // 1000増加
        } else if (event.key === 'ArrowDown') {
            event.preventDefault(); // デフォルトの動作を防止
            input_target_sell_price.value = Math.max(0, currentVal - 1000);  // 1000減少
        }
    });
    input_target_buy_price.addEventListener('keydown', function (event) {
        let currentVal = parseFloat(input_target_buy_price.value) || 0.0;
        if (event.key === 'ArrowUp') {
            event.preventDefault(); // デフォルトの動作を防止
            input_target_buy_price.value = currentVal + 1000;  // 1000増加
        } else if (event.key === 'ArrowDown') {
            event.preventDefault(); // デフォルトの動作を防止
            input_target_buy_price.value = Math.max(0, currentVal - 1000);  // 1000減少
        }
    });
</script>

<!-- ★追加: データをJSONとして埋め込むタグ -->
<script id="graph-data-json" type="application/json">
    {{ graph_data | tojson | safe }}
</script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // start.py から渡されたデータをパース
        const dataElement = document.getElementById('graph-data-json');
        let gData = null;

        try {
            // タグの中身（テキスト）を取り出して、JSONとして復元する
            gData = JSON.parse(dataElement.textContent);
        } catch (e) {
            console.error("JSON Parse Error:", e);
            return;
        }

        // データがない場合は処理を中断
        if (!gData || !gData.history_dates || gData.history_dates.length === 0) {
            console.log("No graph data available.");
            return;
        }

        // 共通カラーパレット (セクターやグループの色分け用)
        const colors = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#64748B',
            '#A855F7', '#D946EF', '#06B6D4', '#84CC16', '#EAB308'
        ];

        // --- 1. 資産推移 (全体) 折れ線グラフ ---
        new Chart(document.getElementById('historyChart'), {
            type: 'line',
            data: {
                labels: gData.history_dates,
                datasets: [
                    {
                        label: '時価総額',
                        data: gData.history_total_assets,
                        borderColor: '#3B82F6', // Blue
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: '投資元本',
                        data: gData.history_total_investment,
                        borderColor: '#9CA3AF', // Gray
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => ctx.dataset.label + ": " + ctx.raw.toLocaleString() + " 円"
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: false } // 金額の変化を見やすくするため0始まりにしない
                }
            }
        });

        // --- 2. 資産推移 (グループ別) 積み上げ面グラフ ---
        // group_history 辞書を datasets 配列に変換
        const groupDatasets = [];
        let colorIdx = 0;
        for (const [groupName, dataArray] of Object.entries(gData.group_history)) {
            groupDatasets.push({
                label: groupName,
                data: dataArray,
                backgroundColor: colors[colorIdx % colors.length] + '80', // 透明度50%
                borderColor: colors[colorIdx % colors.length],
                fill: true
            });
            colorIdx++;
        }

        new Chart(document.getElementById('groupHistoryChart'), {
            type: 'line',
            data: {
                labels: gData.history_dates,
                datasets: groupDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => ctx.dataset.label + ": " + ctx.raw.toLocaleString() + " 円"
                        }
                    }
                },
                scales: {
                    y: { stacked: true } // 積み上げ設定
                }
            }
        });

        // --- 3. セクター比率 (ドーナツ) ---
        new Chart(document.getElementById('sectorChart'), {
            type: 'doughnut',
            data: {
                labels: gData.sector_labels,
                datasets: [{
                    data: gData.sector_values,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                const total = ctx.chart._metasets[ctx.datasetIndex].total;
                                const pct = ((val / total) * 100).toFixed(1);
                                return ctx.label + ": " + val.toLocaleString() + " 円 (" + pct + "%)";
                            }
                        }
                    }
                }
            }
        });

        // --- 4. ヒートマップ (TreeMap) ---
        // セクターごとに色を割り当てるためのロジック
        const sectorColorMap = {};
        gData.sector_labels.forEach((sec, i) => {
            sectorColorMap[sec] = colors[i % colors.length];
        });

        new Chart(document.getElementById('treeMapChart'), {
            type: 'treemap',
            data: {
                datasets: [{
                    label: 'Portfolio',
                    tree: gData.tree_map_data,
                    key: 'value',      // 面積を決める値 (時価評価額)
                    groups: ['sector', 'name'], // 階層: セクター > 銘柄名
                    backgroundColor: (ctx) => {
                        if (ctx.type !== 'data') return 'transparent';
                        // データノードの場合、セクターに応じた色を返す
                        const item = ctx.raw._data; // 生データへのアクセス
                        // 階層の深さによって色を変えるなどの調整も可能
                        // ここでは親(セクター)の色を取得しようとするが、itemの構造依存
                        // 簡易的にランダムに見えないよう、データに含まれるsector名から色を引く
                        if (item.sector && sectorColorMap[item.sector]) {
                            return sectorColorMap[item.sector];
                        }
                        return '#3B82F6';
                    },
                    borderWidth: 1,
                    borderColor: '#fff',
                    spacing: 1,
                    labels: {
                        display: true,
                        formatter: (ctx) => {
                            // 銘柄名と金額を表示
                            if (ctx.raw.v < 50000) return ""; // 小さすぎる場合は非表示
                            return [
                                ctx.raw.g, // グループ名（銘柄名またはセクター名）
                                (ctx.raw.v / 10000).toFixed(0) + "万"
                            ];
                        },
                        color: 'white',
                        font: { size: 12, weight: 'bold' }
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    // 個別銘柄（codeを持っているもの）だけを表示対象にする
                    // これにより、セクターのヘッダー部分ではツールチップが出なくなります
                    tooltip: {
                        filter: (tooltipItem) => {
                            const data = tooltipItem.raw._data;
                            // childrenが存在し、その最初の要素にcodeがあるかチェック
                            return data.children && data.children.length > 0 && data.children[0].code && data.name;
                        },
                        callbacks: {
                            // タイトル: エラー防止のガードを入れる
                            title: (items) => {
                                if (!items || items.length === 0) {
                                    return '';
                                }
                                return items[0].raw._data.name;
                            },
                            // ラベル: children[0] からデータを取り出す
                            label: (ctx) => {
                                const item = ctx.raw._data;
                                // 安全にデータを取り出す
                                const stockData = (item.children && item.children.length > 0) ? item.children[0] : {};
                                return [
                                    "名前: " + item.name,
                                    "セクター: " + item.sector,
                                    "分類: " + (stockData.group || "-"),
                                    "評価額: " + item.value.toLocaleString() + " 円"
                                ];
                            }
                        }
                    }
                }
            }
        });
    });
</script>

{% endblock %}